namespace Management.Storage.ScenarioTest.Functional.SAS
{
    using System.IO;
    using Management.Storage.ScenarioTest.Common;
    using Management.Storage.ScenarioTest.Util;
    using Microsoft.VisualStudio.TestTools.UnitTesting;
    using Microsoft.WindowsAzure.Storage.Queue;
    using MS.Test.Common.MsTestLib;
    using StorageTestLib;
    using BlobType = Microsoft.WindowsAzure.Storage.Blob.BlobType;

    /// <summary>
    /// This class would cover all the cases that would use SAS token(also generated by PS cmdlet) as credentials in PS cmdlets
    /// </summary>
    [TestClass]
    public class SASInterop : TestBase
    {
        private static string commonBlockFilePath;
        private static string commonPageFilePath;
        private static string downloadDirPath;

        private static string StorageEndpoint;

        //In PowerShell cmdlet, we do not allow "*[]'" for blob name because it's for wild card patten
        private const string SpecialCharsPrefix = @"~!@#$%^&()_+";

        [ClassInitialize()]
        public static void SASInteropClassInit(TestContext testContext)
        {
            TestBase.TestClassInitialize(testContext);
            GenerateBvtTempFiles();
            downloadDirPath = Test.Data.Get("DownloadDir");
            StorageEndpoint = Test.Data.Get("StorageEndPoint");
        }

        [ClassCleanup()]
        public static void SASInteropClassCleanup()
        {
            TestBase.TestClassCleanup();
        }

        /// <summary>
        /// test initialize
        /// </summary>
        [TestInitialize()]
        public override void InitAgent()
        {
            CommandAgent = AgentFactory.CreateAgent(TestContext.Properties);

            SetCLIEnv(TestContext);

            Test.Start(TestContext.FullyQualifiedTestClassName, TestContext.TestName);
            OnTestSetup();
        }

        /// <summary>
        /// Generate temp files
        /// </summary>
        private static void GenerateBvtTempFiles()
        {
            bool AlwaysOperateOnWindows = (FileUtil.AgentOSType != OSType.Windows);

            commonBlockFilePath = Path.Combine(Test.Data.Get("TempDir"), FileUtil.GetSpecialFileName());
            commonPageFilePath = Path.Combine(Test.Data.Get("TempDir"), FileUtil.GetSpecialFileName());
            FileUtil.CreateDirIfNotExits(Path.GetDirectoryName(commonBlockFilePath), AlwaysOperateOnWindows);
            FileUtil.CreateDirIfNotExits(Path.GetDirectoryName(commonPageFilePath), AlwaysOperateOnWindows);

            FileUtil.CreateDirIfNotExits(Test.Data.Get("UploadDir"));
            FileUtil.CreateDirIfNotExits(Test.Data.Get("DownloadDir"));
            FileUtil.CreateDirIfNotExits(Test.Data.Get("TempDir"));

            // Generate block file and page file which are used for uploading
            FileUtil.GenerateMediumFile(commonBlockFilePath, Utility.GetRandomTestCount(1, 5), AlwaysOperateOnWindows);
            FileUtil.GenerateMediumFile(commonPageFilePath, Utility.GetRandomTestCount(1, 5), AlwaysOperateOnWindows);
        }

        /// <summary>
        /// 1. Generate SAS of a Blob with read permission
        /// 2. Get blob with the generated SAS token
        /// 3. Download blob with the generated SAS token
        /// 4. Copy blob with the generated SAS token(as source)
        /// </summary>
        [TestMethod()]
        [TestCategory(Tag.Function)]
        [TestCategory(PsTag.Blob)]
        [TestCategory(PsTag.SASInterop)]
        [TestCategory(CLITag.NodeJSFT)]
        [TestCategory(CLITag.SASInterop)]
        public void BlobWithReadPermission()
        {
            BlobOrContainerWithReadPermission(StorageObjectType.Container, BlobType.BlockBlob);
            SetCLIEnv(TestContext); //reset agent env 
            BlobOrContainerWithReadPermission(StorageObjectType.Container, BlobType.PageBlob);
            SetCLIEnv(TestContext); //reset agent env 
            BlobOrContainerWithReadPermission(StorageObjectType.Container, BlobType.AppendBlob);
        }

        /// <summary>
        /// 1. Generate SAS of a Container with read permission
        /// 2. Get blob with the generated SAS token
        /// 3. Download blob with the generated SAS token
        /// 4. Copy blob with the generated SAS token(as source)
        /// </summary>
        [TestMethod()]
        [TestCategory(Tag.Function)]
        [TestCategory(PsTag.Container)]
        [TestCategory(PsTag.SASInterop)]
        [TestCategory(CLITag.NodeJSFT)]
        [TestCategory(CLITag.SASInterop)]
        public void ContainerWithReadPermission()
        {
            BlobOrContainerWithReadPermission(StorageObjectType.Container, BlobType.BlockBlob);
            SetCLIEnv(TestContext); //reset agent env 
            BlobOrContainerWithReadPermission(StorageObjectType.Container, BlobType.PageBlob);
            SetCLIEnv(TestContext); //reset agent env 
            BlobOrContainerWithReadPermission(StorageObjectType.Container, BlobType.AppendBlob);
        }

        public void BlobOrContainerWithReadPermission(StorageObjectType objectType, BlobType blobType)
        {
            blobUtil.SetupTestContainerAndBlob(SpecialCharsPrefix, blobType);

            try
            {
                CommandAgent.SetContextWithSASToken(StorageAccount.Credentials.AccountName, blobUtil, objectType, StorageEndpoint, string.Empty, "r");

                // Get blob with the generated SAS token
                Test.Assert(CommandAgent.GetAzureStorageBlob(blobUtil.Blob.Name, blobUtil.ContainerName),
                    string.Format("Get existing blob {0} in container {1} should succeed", blobUtil.Blob.Name, blobUtil.ContainerName));

                // Download blob with the generated SAS token
                string downloadFilePath = Path.Combine(downloadDirPath, blobUtil.Blob.Name);
                Test.Assert(CommandAgent.GetAzureStorageBlobContent(blobUtil.Blob.Name, downloadFilePath, blobUtil.ContainerName),
                    string.Format("Download blob {0} in container {1} to File {2} should succeed", blobUtil.Blob.Name, blobUtil.ContainerName, downloadFilePath));

                // Copy blob with the generated SAS token(as source)
                string copiedName = Utility.GenNameString("copied");
                object destContext = null;
                if (lang == Language.PowerShell)
                {
                    destContext = PowerShellAgent.GetStorageContext(StorageAccount.ToString(true));
                }
                else
                {
                    destContext = StorageAccount;
                }

                Test.Assert(CommandAgent.StartAzureStorageBlobCopy(blobUtil.ContainerName, blobUtil.Blob.Name, blobUtil.ContainerName, copiedName, destContext: destContext),
                    string.Format("Copy blob {0} in container {1} to blob {2} in container {3} should succeed",
                    blobUtil.Blob.Name, blobUtil.ContainerName, blobUtil.ContainerName, copiedName));
            }
            finally
            {
                blobUtil.CleanupTestContainerAndBlob();
            }
        }

        /// <summary>
        /// 1. Generate SAS of a Container with write permission
        /// 2. Upload blob with the generated SAS token
        /// </summary>
        [TestMethod()]
        [TestCategory(Tag.Function)]
        [TestCategory(PsTag.Container)]
        [TestCategory(PsTag.SASInterop)]
        public void ContainerWithWritePermission()
        {
            BlobOrContainerWithWritePermission(commonBlockFilePath, StorageObjectType.Container, BlobType.BlockBlob);
            SetCLIEnv(TestContext); //reset agent env 
            BlobOrContainerWithWritePermission(commonPageFilePath, StorageObjectType.Container, BlobType.PageBlob);
            SetCLIEnv(TestContext); //reset agent env 
            BlobOrContainerWithWritePermission(commonPageFilePath, StorageObjectType.Container, BlobType.AppendBlob);
        }

        /// <summary>
        /// 1. Generate SAS of a Blob with write permission
        /// 2. Upload blob with the generated SAS token
        /// </summary>
        [TestMethod()]
        [TestCategory(Tag.Function)]
        [TestCategory(PsTag.Blob)]
        [TestCategory(PsTag.SASInterop)]
        public void BlobWithWritePermission()
        {
            BlobOrContainerWithWritePermission(commonBlockFilePath, StorageObjectType.Blob, BlobType.BlockBlob);
            SetCLIEnv(TestContext); //reset agent env 
            BlobOrContainerWithWritePermission(commonPageFilePath, StorageObjectType.Blob, BlobType.PageBlob);
            SetCLIEnv(TestContext); //reset agent env 
            BlobOrContainerWithWritePermission(commonPageFilePath, StorageObjectType.Blob, BlobType.AppendBlob);
        }

        public void BlobOrContainerWithWritePermission(string uploadFilePath, StorageObjectType objectType, BlobType type)
        {
            blobUtil.SetupTestContainerAndBlob(type);
            try
            {
                CommandAgent.SetContextWithSASToken(StorageAccount.Credentials.AccountName, blobUtil, objectType, StorageEndpoint, string.Empty, "rw");

                // Upload blob with the generated SAS token
                Test.Assert(CommandAgent.SetAzureStorageBlobContent(uploadFilePath, blobUtil.ContainerName, type, blobUtil.Blob.Name),
                    string.Format("Overwriting existing blob {0} in container {1} should succeed", blobUtil.Blob.Name, blobUtil.ContainerName));
            }
            finally
            {
                blobUtil.CleanupTestContainerAndBlob();
            }
        }

        /// <summary>
        /// 1. Generate SAS of a Container with delete permission
        /// 2. Delete blob with the generated SAS token
        /// </summary>
        [TestMethod()]
        [TestCategory(Tag.Function)]
        [TestCategory(PsTag.Container)]
        [TestCategory(PsTag.SASInterop)]
        [TestCategory(CLITag.NodeJSFT)]
        [TestCategory(CLITag.SASInterop)]
        public void ContainerWithDeletePermission()
        {
            BlobOrContainerWithDeletePermission(StorageObjectType.Container);
        }

        /// <summary>
        /// 1. Generate SAS of a Blob with delete permission
        /// 2. Delete blob with the generated SAS token
        /// </summary>
        [TestMethod()]
        [TestCategory(Tag.Function)]
        [TestCategory(PsTag.Blob)]
        [TestCategory(PsTag.SASInterop)]
        [TestCategory(CLITag.NodeJSFT)]
        [TestCategory(CLITag.SASInterop)]
        public void BlobWithDeletePermission()
        {
            BlobOrContainerWithDeletePermission(StorageObjectType.Blob);
        }

        public void BlobOrContainerWithDeletePermission(StorageObjectType objectType)
        {
            blobUtil.SetupTestContainerAndBlob();
            try
            {
                CommandAgent.SetContextWithSASToken(StorageAccount.Credentials.AccountName, blobUtil, objectType, StorageEndpoint, string.Empty, "rd");

                // Delete blob with the generated SAS token
                Test.Assert(CommandAgent.RemoveAzureStorageBlob(blobUtil.Blob.Name, blobUtil.ContainerName),
                    string.Format("Remove blob {0} in container {1} should succeed", blobUtil.Blob.Name, blobUtil.ContainerName));
            }
            finally
            {
                blobUtil.CleanupTestContainerAndBlob();
            }
        }

        /// <summary>
        /// 1. Generate SAS of a Container with list permission
        /// 2. List blobs with the generated SAS token
        /// </summary>
        [TestMethod()]
        [TestCategory(Tag.Function)]
        [TestCategory(PsTag.Container)]
        [TestCategory(PsTag.SASInterop)]
        [TestCategory(CLITag.NodeJSFT)]
        [TestCategory(CLITag.SASInterop)]
        public void ContainerWithListPermission()
        {
            blobUtil.SetupTestContainerAndBlob();
            try
            {
                string sastoken = CommandAgent.GetContainerSasFromCmd(blobUtil.ContainerName, string.Empty, "l");
                CommandAgent.SetStorageContextWithSASToken(StorageAccount.Credentials.AccountName, sastoken, StorageEndpoint);

                // List blobs with the generated SAS token
                Test.Assert(CommandAgent.GetAzureStorageBlob(string.Empty, blobUtil.ContainerName),
                    string.Format("List blobs in container {0} should succeed", blobUtil.ContainerName));
            }
            finally
            {
                blobUtil.CleanupTestContainerAndBlob();
            }
        }

        /// <summary>
        /// 1. Generate SAS of a Queue with read permission
        /// 2. Get queue with the generated SAS token
        /// </summary>
        [TestMethod()]
        [TestCategory(Tag.Function)]
        [TestCategory(PsTag.Queue)]
        [TestCategory(PsTag.SASInterop)]
        [TestCategory(CLITag.NodeJSFT)]
        [TestCategory(CLITag.SASInterop)]
        public void QueueWithReadPermission()
        {
            CloudQueue queue = queueUtil.CreateQueue();
            try
            {
                string sastoken = CommandAgent.GetQueueSasFromCmd(queue.Name, string.Empty, "r");
                CommandAgent.SetStorageContextWithSASToken(StorageAccount.Credentials.AccountName, sastoken, StorageEndpoint);

                //list specified queue with properties and meta data
                Test.Assert(CommandAgent.GetAzureStorageQueue(queue.Name), Utility.GenComparisonData("GetAzureStorageQueue", true));
            }
            finally
            {
                queueUtil.RemoveQueue(queue.Name);
            }
        }
    }
}
